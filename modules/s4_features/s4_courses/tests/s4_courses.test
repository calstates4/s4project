<?php

require_once(drupal_get_path('module', 's4_core') .'/tests/s4_core_base_test.php');

class S4CoursesTestCase extends s4WebTestCase {
	
	public static function getInfo() {
    return array(
      'name' => 'S4 Couse Test',
      'description' => 'Test course management and student signup.',
      'group' => 'Student Signup',
    );
  }
  
  public function setUp() {
  	parent::setUp($this->modules);  	
  }
  
  public function testCourseCreation() {
  	$this->drupalLogout();
	$this->drupalLogin($this->drupalCreateUser($this->roles['administrator']));
	$term_code = $this->randomName(8);
	$term = $this->drupalCreateNode(array('type' => 'course_term',
										  'title' => 'Fall 2012',
										  'field_term_code' => array('en' => array(array('value' => $term_code))),
										  'field_term_date_start' => array('en' => array(array('value' => '2011-07-10T00:00:00')))));
	$this->drupalGet('node/'. $term->nid);
	$this->assertText($term_code);
	$faculty = $this->drupalCreateUser($this->roles['authenticated']);
	$student = $this->drupalCreateUser($this->roles['authenticated']);
	$course_name = $this->randomName(8);
	$course = $this->drupalCreateNode(array('type' => 'course',
											'field_course_section' => array('en' => array(array('value' => 1))),
											'field_course_faculty' => array('en' => array(array('uid' => $faculty->uid))),
											'field_course_catalog_number' => array('en' => array(array('value' => '101'))),
											'field_course_subject' => array('en' => array(array('value' => 'SL'))),
											'field_course_title' => array('en' => array(array('value' => $course_name))),
											'field_term' => array('en' => array(array('nid' => $term->nid))),
											'field_course_students' => array('en' => array(array('uid' => $student->uid)))));
	
  	$this->drupalGet('courses');
  	$this->assertText($course_name);
	
	$this->drupalGet('node/'. $course->nid);
	$this->drupalLogout();
	$this->drupalLogin($faculty);
	$this->drupalGet('node/'. $course->nid);
  	$this->assertNoText(t('Access denied'));
	
	$this->drupalLogout();
	$this->drupalLogin($student);
	$this->drupalGet('node/'. $course->nid);
  	$this->assertNoText(t('Access denied'));
  	
  	$this->drupalLogout();
  	$this->drupalGet('node/'. $course->nid);
  	$this->assertText(t('Access denied'));
  	
  	
  }
  
  public function testCourseList() {
  	$this->drupalLogout();
	$this->drupalLogin($this->drupalCreateUser($this->roles['administrator']));
	$this->drupalGet('courses');
	$this->assertText('101');
  }
}